<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Weekly Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --primary: #2563EB;
            --primary-light: #3B82F6;
            --primary-dark: #1D4ED8;
            --secondary: #60A5FA;
            --accent: #93C5FD;
            --background: #F8FAFC;
            --card: #FFFFFF;
            --text: #1E293B;
            --text-light: #64748B;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text);
        }

        .gradient-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .card-hover {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .card-hover:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .health-score {
            position: relative;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .health-score-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            border-radius: 4px;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .chart-container {
            position: relative;
            height: 250px;
            min-height: 250px;
        }

        .glow {
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.3);
        }

        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(37, 99, 235, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 200px;
            }
        }
    </style>
</head>
<body class="bg-[var(--background)] text-[var(--text)]">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <div class="gradient-bg text-white py-4 px-4 shadow-lg sticky top-0 z-50">
            <div class="container mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center">
                        <div class="bg-white/20 p-2 rounded-lg mr-3">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-xl md:text-2xl font-bold">Business Weekly Report</h1>
                            <p class="text-blue-100 mt-1 text-sm">Real-time Business Intelligence Dashboard</p>
                        </div>
                    </div>
                    <div class="flex items-center mt-3 md:mt-0 space-x-2">
                        <button id="toggleAnomalyBtn" class="bg-white text-[var(--primary)] hover:bg-blue-50 px-3 py-1 md:px-4 md:py-2 rounded-lg font-medium flex items-center transition-all glow smooth-transition">
                            <i class="fas fa-eye-slash mr-2"></i>
                            <span class="hidden md:inline">Hide Anomaly</span>
                        </button>
                        <button id="exportBtn" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1 md:px-4 md:py-2 rounded-lg font-medium flex items-center smooth-transition group">
                            <i class="fas fa-file-export mr-2"></i>
                            <span class="hidden md:inline">Export</span>
                            <div class="absolute hidden group-hover:block bg-white text-[var(--text)] shadow-lg rounded-lg mt-12 py-1 w-32 z-10">
                                <button id="exportCSV" class="w-full text-left px-3 py-1 hover:bg-blue-50 text-sm">CSV</button>
                                <button id="exportPDF" class="w-full text-left px-3 py-1 hover:bg-blue-50 text-sm">PDF</button>
                                <button id="exportExcel" class="w-full text-left px-3 py-1 hover:bg-blue-50 text-sm">Excel</button>
                            </div>
                        </button>
                        <button id="refreshBtn" class="bg-white hover:bg-blue-50 text-[var(--primary)] px-3 py-1 md:px-4 md:py-2 rounded-lg font-medium flex items-center smooth-transition">
                            <i class="fas fa-sync-alt mr-2"></i>
                            <span class="hidden md:inline">Refresh</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Update Status -->
        <div class="bg-blue-50 py-2 px-4 border-b border-blue-100">
            <div class="container mx-auto flex justify-between items-center text-sm">
                <div id="updateNotification" class="hidden bg-green-600 text-white px-3 py-1 rounded-lg shadow-lg flex items-center">
                    <i class="fas fa-check-circle mr-2"></i> Data updated successfully!
                </div>
                <div class="text-[var(--text-light)] flex items-center text-xs md:text-sm">
                    <span id="lastUpdated" class="flex items-center">
                        <i class="fas fa-clock mr-1"></i> Last updated: Never
                    </span>
                    <span class="mx-2">|</span>
                    <span id="updateStatus" class="font-medium flex items-center">
                        <span id="statusIcon" class="mr-1"><i class="fas fa-circle-notch fa-spin"></i></span>
                        <span>Updating...</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container mx-auto px-4 py-6 flex-grow">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-[var(--card)] rounded-xl p-4 card-hover border-l-4 border-[var(--primary)]">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[var(--text-light)] text-xs md:text-sm font-medium">Total Revenue</p>
                            <h3 class="text-xl md:text-2xl font-bold mt-1" id="totalRevenue">Rp0</h3>
                        </div>
                        <div class="bg-blue-50 p-2 md:p-3 rounded-lg">
                            <i class="fas fa-wallet text-[var(--primary)] text-lg"></i>
                        </div>
                    </div>
                    <div class="mt-3 pt-2 border-t border-blue-100 flex items-center">
                        <span id="revenueChange" class="text-green-600 text-xs md:text-sm font-medium flex items-center">
                            <i class="fas fa-arrow-up mr-1"></i> 0%
                        </span>
                        <span class="text-[var(--text-light)] text-xs ml-2">vs last week</span>
                    </div>
                </div>

                <div class="bg-[var(--card)] rounded-xl p-4 card-hover border-l-4 border-[var(--secondary)]">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[var(--text-light)] text-xs md:text-sm font-medium">Total Transactions</p>
                            <h3 class="text-xl md:text-2xl font-bold mt-1" id="totalTransactions">0</h3>
                        </div>
                        <div class="bg-blue-50 p-2 md:p-3 rounded-lg">
                            <i class="fas fa-shopping-cart text-[var(--secondary)] text-lg"></i>
                        </div>
                    </div>
                    <div class="mt-3 pt-2 border-t border-blue-100 flex items-center">
                        <span id="transactionsChange" class="text-red-500 text-xs md:text-sm font-medium flex items-center">
                            <i class="fas fa-arrow-down mr-1"></i> 0%
                        </span>
                        <span class="text-[var(--text-light)] text-xs ml-2">vs last week</span>
                    </div>
                </div>

                <div class="bg-[var(--card)] rounded-xl p-4 card-hover border-l-4 border-[var(--accent)]">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[var(--text-light)] text-xs md:text-sm font-medium">Avg. Revenue</p>
                            <h3 class="text-xl md:text-2xl font-bold mt-1" id="avgRevenue">Rp0</h3>
                        </div>
                        <div class="bg-blue-50 p-2 md:p-3 rounded-lg">
                            <i class="fas fa-chart-pie text-[var(--accent)] text-lg"></i>
                        </div>
                    </div>
                    <div class="mt-3 pt-2 border-t border-blue-100">
                        <div class="flex justify-between text-xs text-[var(--text-light)]">
                            <span>Min: <span id="minRevenue">Rp0</span></span>
                            <span>Max: <span id="maxRevenue">Rp0</span></span>
                        </div>
                    </div>
                </div>

                <div class="bg-[var(--card)] rounded-xl p-4 card-hover border-l-4 border-blue-400">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[var(--text-light)] text-xs md:text-sm font-medium">Health Score</p>
                            <h3 class="text-xl md:text-2xl font-bold mt-1" id="avgHealthScore">0</h3>
                        </div>
                        <div class="bg-blue-50 p-2 md:p-3 rounded-lg">
                            <i class="fas fa-heartbeat text-blue-400 text-lg"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="health-score bg-blue-100">
                            <div class="health-score-bar bg-gradient-to-r from-blue-400 to-blue-600" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-[var(--text-light)] mt-1">Average score this week</p>
                    </div>
                </div>
            </div>

            <!-- Data Visualization Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-[var(--card)] rounded-xl p-4 card-hover">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Revenue Trend</h2>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-[var(--text-light)]">Weekly</span>
                            <div class="w-2 h-2 rounded-full bg-[var(--primary)]"></div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <div class="bg-[var(--card)] rounded-xl p-4 card-hover">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Transactions Trend</h2>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-[var(--text-light)]">Weekly</span>
                            <div class="w-2 h-2 rounded-full bg-[var(--secondary)]"></div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="transactionsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Insights and Recommendations -->
            <div class="bg-[var(--card)] rounded-xl p-4 card-hover mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Insights & Recommendations</h2>
                    <i class="fas fa-lightbulb text-yellow-500"></i>
                </div>
                <div id="insightsContainer" class="space-y-4">
                    <div class="bg-blue-50 rounded-lg p-3">
                        <div class="flex items-start">
                            <div class="bg-[var(--primary)] text-white p-2 rounded-lg mr-3">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div>
                                <h3 class="font-medium">Initializing data...</h3>
                                <p class="text-sm text-[var(--text-light)] mt-1">Please wait while we load the latest insights.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Data Table -->
            <div class="bg-[var(--card)] rounded-xl p-4 card-hover">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Recent Data</h2>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-[var(--text-light)]">Last 7 days</span>
                        <div class="w-2 h-2 rounded-full bg-[var(--accent)]"></div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-sm text-[var(--text-light)] border-b border-blue-100">
                                <th class="pb-2">Date</th>
                                <th class="pb-2">Revenue</th>
                                <th class="pb-2">Transactions</th>
                                <th class="pb-2">Health Score</th>
                                <th class="pb-2">Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentDataTable" class="divide-y divide-blue-100">
                            <tr>
                                <td colspan="5" class="py-4 text-center text-[var(--text-light)]">
                                    <div class="flex justify-center items-center">
                                        <div class="spinner mr-2"></div>
                                        Loading data...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-blue-50 py-4 px-4 border-t border-blue-100">
            <div class="container mx-auto text-center text-xs text-[var(--text-light)]">
                Â© 2024 BlueWave Analytics. All rights reserved.
            </div>
        </div>
    </div>

    <script>
        let dailyData = [];
        let weeklyData = {};
        let showAnomaly = true;
        let lastHtmlString = "";
        let revenueChart = null;
        let transactionsChart = null;
        let lastFetchTime = 0;
        const FETCH_INTERVAL = 600000; // 10 menit

        function formatTimestamp() {
            const now = new Date();
            return now.toLocaleString('en-US', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate();
            const month = date.toLocaleString('en-US', { month: 'short' });
            return `${day} ${month}`;
        }

        function showError(message) {
            const updateStatusEl = document.getElementById("updateStatus");
            updateStatusEl.innerHTML = `<span id="statusIcon" class="mr-1"><i class="fas fa-exclamation-triangle"></i></span> ${message}`;
            updateStatusEl.classList.remove("text-blue-500", "text-green-600");
            updateStatusEl.classList.add("text-red-500");
            console.error(message);
        }

        function generateDefaultData(lastDate, daysToFill = 7) {
            const defaultDailyData = [];
            const last = new Date(lastDate);
            for (let i = daysToFill - 1; i >= 0; i--) {
                const date = new Date(last);
                date.setDate(last.getDate() - i);
                const formattedDate = date.toISOString().split('T')[0];
                defaultDailyData.push({
                    date: formattedDate,
                    revenue: 0,
                    transaksi: 0,
                    revenue_change: 0,
                    transaksi_change: 0,
                    health_score: 0,
                    status: "No Data",
                    notes: "No data available",
                    insight: "No insights available"
                });
            }
            return defaultDailyData;
        }

        async function fetchDataFromSpreadsheet() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                const response = await fetch('/api/fetch-sheet', { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                lastFetchTime = Date.now();
                return data.htmlString;
            } catch (error) {
                if (error.name === 'AbortError') throw new Error("Timeout: Could not fetch data within 10 seconds");
                throw new Error(`Failed to fetch data: ${error.message}`);
            }
        }

        function parseHtmlToItems(htmlString) {
            if (!htmlString || typeof htmlString !== 'string') {
                throw new Error("HTML string is empty or invalid");
            }

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            const ulElement = doc.querySelector('ul');
            if (!ulElement) throw new Error("No <ul> element found in HTML Report");

            const dailyItems = Array.from(doc.querySelectorAll('ul li')).map(li => {
                const text = li.innerHTML.replace(/<br>/g, '\n').replace(/<[^>]+>/g, '');
                const lines = text.split('\n').map(line => line.trim());

                const dateMatch = lines[0]?.match(/ðŸ“† (\d{4}-\d{2}-\d{2})/);
                const revenueMatch = lines[1]?.match(/ðŸ’µ Revenue: Rp([\d.]+)/);
                const revenueChangeMatch = lines[2]?.match(/ðŸ“ˆ Perubahan Revenue: ([\d-]+%|Tidak ada data)/);
                const transaksiMatch = lines[3]?.match(/ðŸ§¾ Transaksi: (\d+)/);
                const transaksiChangeMatch = lines[4]?.match(/ðŸ“‰ Perubahan Transaksi: ([\d-]+%|Tidak ada data)/);
                const healthScoreMatch = lines[5]?.match(/ðŸ“Š Health Score: (\d+)/);
                const statusMatch = lines[5]?.match(/D\d+ - [A-Za-z]+ \([A-Za-z]+\)/);
                const notesMatch = lines[6]?.match(/ðŸ“ Catatan: (.+)/);
                const insightMatch = lines[7]?.match(/ðŸ” Insight: (.+)/);

                return {
                    date: dateMatch ? dateMatch[1] : "N/A",
                    revenue: revenueMatch ? parseInt(revenueMatch[1].replace(/\./g, '')) : 0,
                    transaksi: transaksiMatch ? parseInt(transaksiMatch[1]) : 0,
                    revenue_change: revenueChangeMatch ? (revenueChangeMatch[1] === "Tidak ada data" ? 0 : parseInt(revenueChangeMatch[1])) : 0,
                    transaksi_change: transaksiChangeMatch ? (transaksiChangeMatch[1] === "Tidak ada data" ? 0 : parseInt(transaksiChangeMatch[1])) : 0,
                    health_score: healthScoreMatch ? parseInt(healthScoreMatch[1]) : 0,
                    status: statusMatch ? statusMatch[0].split(' - ')[1].split(' (')[0] : "No status",
                    notes: notesMatch ? notesMatch[1] : "No notes",
                    insight: insightMatch ? insightMatch[1] : "No insight"
                };
            });

            dailyItems.sort((a, b) => new Date(a.date) - new Date(b.date));
            const lastDate = dailyItems.length > 0 ? dailyItems[dailyItems.length - 1].date : "2024-01-03";
            const defaultData = generateDefaultData(lastDate, 7);
            const existingDates = dailyItems.map(item => item.date);
            const mergedData = defaultData.map(defaultItem => {
                const existingItem = dailyItems.find(item => item.date === defaultItem.date);
                return existingItem || defaultItem;
            });

            const weeklyData = {};
            const weeklyParagraphs = Array.from(doc.querySelectorAll('p')).map(p => p.innerHTML.replace(/<[^>]+>/g, ''));
            weeklyParagraphs.forEach(paragraph => {
                if (paragraph.includes('Total Revenue')) {
                    const match = paragraph.match(/ðŸ’° Total Revenue: Rp([\d.]+)/);
                    weeklyData.sum_revenue = match ? parseInt(match[1].replace(/\./g, '')) : 0;
                }
                if (paragraph.includes('Total Transaksi')) {
                    const match = paragraph.match(/ðŸ§¾ Total Transaksi: (\d+)/);
                    weeklyData.sum_transaksi = match ? parseInt(match[1]) : 0;
                }
                if (paragraph.includes('Rata-rata Revenue')) {
                    const match = paragraph.match(/ðŸ“ˆ Rata-rata Revenue: Rp([\d.]+)/);
                    weeklyData.average_revenue = match ? parseInt(match[1].replace(/\./g, '')) : 0;
                }
                if (paragraph.includes('Rata-rata Transaksi')) {
                    const match = paragraph.match(/ðŸ“Š Rata-rata Transaksi: ([\d.]+)/);
                    weeklyData.average_transaksi = match ? parseFloat(match[1]) : 0;
                }
                if (paragraph.includes('Max Revenue')) {
                    const match = paragraph.match(/ðŸ”¼ Max Revenue: Rp([\d.]+)/);
                    weeklyData.max_revenue = match ? parseInt(match[1].replace(/\./g, '')) : 0;
                }
                if (paragraph.includes('Min Revenue')) {
                    const match = paragraph.match(/ðŸ”½ Min Revenue: Rp([\d.]+)/);
                    weeklyData.min_revenue = match ? parseInt(match[1].replace(/\./g, '')) : 0;
                }
                if (paragraph.includes('Prediksi Revenue')) {
                    const match = paragraph.match(/ðŸ§® Prediksi Revenue Hari Ke-8: Rp([\d.]+)/);
                    weeklyData.predicted_revenue_day_8 = match ? parseInt(match[1].replace(/\./g, '')) : 0;
                }
                if (paragraph.includes('Trend Revenue')) {
                    const match = paragraph.match(/ðŸ“‰ Trend Revenue: (.+)/);
                    weeklyData.revenue_trend = match ? match[1] : "Stable";
                }
                if (paragraph.includes('Trend Transaksi')) {
                    const match = paragraph.match(/ðŸ“‰ Trend Transaksi: (.+)/);
                    weeklyData.transaction_trend = match ? match[1] : "Stable";
                }
            });

            return { dailyItems: mergedData, weeklyData };
        }

        async function updateDataAndUI(forceFetch = false) {
            const lastUpdatedEl = document.getElementById("lastUpdated");
            const updateStatusEl = document.getElementById("updateStatus");

            lastUpdatedEl.innerHTML = `<i class="fas fa-clock mr-1"></i> Last updated: ${formatTimestamp()}`;
            updateStatusEl.innerHTML = `<span id="statusIcon" class="mr-1"><i class="fas fa-circle-notch fa-spin"></i></span> Updating...`;
            updateStatusEl.classList.remove("text-green-600", "text-red-500");
            updateStatusEl.classList.add("text-blue-500");

            try {
                let htmlString = lastHtmlString;
                const currentTime = Date.now();

                if (forceFetch || (currentTime - lastFetchTime) >= FETCH_INTERVAL) {
                    htmlString = await fetchDataFromSpreadsheet();
                } else {
                    console.log("Using cached data to reduce API requests");
                }

                if (htmlString === lastHtmlString && !forceFetch) {
                    updateStatusEl.innerHTML = `<span id="statusIcon" class="mr-1"><i class="fas fa-check-circle"></i></span> Updated (No changes)`;
                    updateStatusEl.classList.remove("text-blue-500", "text-red-500");
                    updateStatusEl.classList.add("text-green-600");
                    return;
                }

                lastHtmlString = htmlString;
                const parsedData = parseHtmlToItems(htmlString);

                dailyData = parsedData.dailyItems;
                weeklyData = parsedData.weeklyData;

                updateUI();

                const notification = document.getElementById("updateNotification");
                notification.classList.remove("hidden");
                setTimeout(() => notification.classList.add("hidden"), 3000);

                updateStatusEl.innerHTML = `<span id="statusIcon" class="mr-1"><i class="fas fa-check-circle"></i></span> Updated`;
                updateStatusEl.classList.remove("text-blue-500", "text-red-500");
                updateStatusEl.classList.add("text-green-600");
            } catch (error) {
                lastUpdatedEl.innerHTML = `<i class="fas fa-clock mr-1"></i> Last updated: ${formatTimestamp()}`;
                showError(`Failed to update: ${error.message}`);

                dailyData = generateDefaultData("2024-01-03", 7);
                weeklyData = {
                    sum_revenue: 0,
                    sum_transaksi: 0,
                    average_revenue: 0,
                    average_transaksi: 0,
                    max_revenue: 0,
                    min_revenue: 0,
                    predicted_revenue_day_8: 0,
                    revenue_trend: "Stable",
                    transaction_trend: "Stable"
                };
                updateUI();
            }
        }

        function updateUI() {
            document.getElementById("totalRevenue").textContent = `Rp${weeklyData.sum_revenue.toLocaleString("id-ID")}`;
            document.getElementById("totalTransactions").textContent = weeklyData.sum_transaksi;
            document.getElementById("avgRevenue").textContent = `Rp${weeklyData.average_revenue.toLocaleString("id-ID")}`;
            document.getElementById("minRevenue").textContent = `Rp${weeklyData.min_revenue.toLocaleString("id-ID")}`;
            document.getElementById("maxRevenue").textContent = `Rp${weeklyData.max_revenue.toLocaleString("id-ID")}`;

            document.getElementById("revenueChange").innerHTML = 
                weeklyData.revenue_trend === "Naik" ? 
                `<i class="fas fa-arrow-up mr-1"></i> ${Math.abs(dailyData[dailyData.length - 1].revenue_change)}%` :
                `<i class="fas fa-arrow-down mr-1"></i> ${Math.abs(dailyData[dailyData.length - 1].revenue_change)}%`;
            document.getElementById("revenueChange").classList.remove("text-green-600", "text-red-500");
            document.getElementById("revenueChange").classList.add(weeklyData.revenue_trend === "Naik" ? "text-green-600" : "text-red-500");

            document.getElementById("transactionsChange").innerHTML = 
                weeklyData.transaction_trend === "Naik" ? 
                `<i class="fas fa-arrow-up mr-1"></i> ${Math.abs(dailyData[dailyData.length - 1].transaksi_change)}%` :
                `<i class="fas fa-arrow-down mr-1"></i> ${Math.abs(dailyData[dailyData.length - 1].transaksi_change)}%`;
            document.getElementById("transactionsChange").classList.remove("text-green-600", "text-red-500");
            document.getElementById("transactionsChange").classList.add(weeklyData.transaction_trend === "Naik" ? "text-green-600" : "text-red-500");

            const avgHealthScore = dailyData.reduce((sum, day) => sum + day.health_score, 0) / dailyData.length;
            document.getElementById("avgHealthScore").textContent = Math.round(avgHealthScore);
            document.querySelector(".health-score-bar").style.width = `${avgHealthScore}%`;

            updateCharts();
            updateInsights();
            updateRecentDataTable();
        }

        function updateCharts() {
            const dates = dailyData.map(item => formatDate(item.date));
            const revenues = dailyData.map(item => item.revenue);
            const transactions = dailyData.map(item => item.transaksi);

            if (revenueChart) revenueChart.destroy();
            revenueChart = new Chart(document.getElementById('revenueChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Revenue',
                        data: revenues,
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: 'rgba(100, 116, 139, 1)' } },
                        y: {
                            grid: { color: 'rgba(226, 232, 240, 1)' },
                            ticks: {
                                color: 'rgba(100, 116, 139, 1)',
                                callback: value => `Rp${(value / 1000000).toFixed(0)}M`
                            }
                        }
                    }
                }
            });

            if (transactionsChart) transactionsChart.destroy();
            transactionsChart = new Chart(document.getElementById('transactionsChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Transactions',
                        data: transactions,
                        backgroundColor: 'rgba(96, 165, 250, 0.1)',
                        borderColor: 'rgba(96, 165, 250, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: 'rgba(100, 116, 139, 1)' } },
                        y: { grid: { color: 'rgba(226, 232, 240, 1)' }, ticks: { color: 'rgba(100, 116, 139, 1)', precision: 0 } }
                    }
                }
            });
        }

        function updateInsights() {
            const insightsContainer = document.getElementById("insightsContainer");
            insightsContainer.innerHTML = '';

            const weeklyInsight = {
                title: "Weekly Performance Summary",
                content: `This week's total revenue was Rp${weeklyData.sum_revenue.toLocaleString('id-ID')} with ${weeklyData.sum_transaksi} transactions. 
                The revenue trend is ${weeklyData.revenue_trend.toLowerCase()} and transactions are ${weeklyData.transaction_trend.toLowerCase()}. 
                Predicted revenue for tomorrow is Rp${weeklyData.predicted_revenue_day_8.toLocaleString('id-ID')}.`,
                icon: "fas fa-chart-line",
                color: "bg-[var(--primary)]"
            };
            addInsightCard(weeklyInsight);

            const recentDays = dailyData.filter(day => day.revenue !== 0).slice(0, 3);
            recentDays.forEach(day => {
                const insight = {
                    title: `Performance on ${day.date}`,
                    content: `${day.insight}. Revenue was Rp${day.revenue.toLocaleString('id-ID')} with ${day.transaksi} transactions. 
                    Health score was ${day.health_score} (${day.status}).`,
                    icon: "fas fa-calendar-day",
                    color: day.health_score > 70 ? "bg-green-500" : day.health_score > 60 ? "bg-blue-500" : "bg-yellow-500"
                };
                addInsightCard(insight);
            });

            const recommendation = {
                title: "Recommendations",
                content: weeklyData.revenue_trend === "Naik" ? 
                    "Continue current strategies as they are working well. Consider increasing inventory for popular products." : 
                    "Review marketing strategies. Consider running promotions or discounts to boost sales.",
                icon: "fas fa-lightbulb",
                color: "bg-yellow-500"
            };
            addInsightCard(recommendation);
        }

        function addInsightCard(insight) {
            const insightsContainer = document.getElementById("insightsContainer");
            const insightCard = document.createElement("div");
            insightCard.className = "bg-blue-50 rounded-lg p-3";
            insightCard.innerHTML = `
                <div class="flex items-start">
                    <div class="${insight.color} text-white p-2 rounded-lg mr-3">
                        <i class="${insight.icon}"></i>
                    </div>
                    <div>
                        <h3 class="font-medium">${insight.title}</h3>
                        <p class="text-sm text-[var(--text-light)] mt-1">${insight.content}</p>
                    </div>
                </div>
            `;
            insightsContainer.appendChild(insightCard);
        }

        function updateRecentDataTable() {
            const tableBody = document.getElementById("recentDataTable");
            tableBody.innerHTML = '';

            dailyData.forEach(item => {
                const row = document.createElement("tr");
                let statusColor = "bg-gray-100 text-gray-800";
                if (item.status === "Hijau") statusColor = "bg-green-100 text-green-800";
                else if (item.status === "Kuning") statusColor = "bg-yellow-100 text-yellow-800";
                else if (item.status === "Merah") statusColor = "bg-red-100 text-red-800";
                else if (item.status === "No Data") statusColor = "bg-gray-100 text-gray-800";

                row.innerHTML = `
                    <td class="py-3 text-sm">${item.date}</td>
                    <td class="py-3 text-sm">Rp${item.revenue.toLocaleString('id-ID')}</td>
                    <td class="py-3 text-sm">${item.transaksi}</td>
                    <td class="py-3 text-sm">
                        <div class="flex items-center">
                            <div class="w-8 h-2 bg-gray-200 rounded-full mr-2">
                                <div class="h-2 rounded-full ${item.health_score > 70 ? 'bg-green-500' : item.health_score > 60 ? 'bg-blue-500' : item.health_score > 0 ? 'bg-yellow-500' : 'bg-gray-500'}" 
                                     style="width: ${item.health_score}%"></div>
                            </div>
                            <span>${item.health_score}</span>
                        </div>
                    </td>
                    <td class="py-3 text-sm">
                        <span class="status-badge ${statusColor}">${item.status}</span>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function toggleAnomaly() {
            showAnomaly = !showAnomaly;
            const btn = document.getElementById("toggleAnomalyBtn");
            if (showAnomaly) {
                btn.innerHTML = '<i class="fas fa-eye-slash mr-2"></i> <span class="hidden md:inline">Hide Anomaly</span>';
                btn.classList.remove("bg-red-100", "text-red-800");
                btn.classList.add("bg-white", "text-[var(--primary)]", "glow");
            } else {
                btn.innerHTML = '<i class="fas fa-eye mr-2"></i> <span class="hidden md:inline">Show Anomaly</span>';
                btn.classList.remove("bg-white", "text-[var(--primary)]", "glow");
                btn.classList.add("bg-red-100", "text-red-800");
            }
            updateUI();
        }

        function exportToCSV() {
            const data = [
                ["Date", "Revenue", "Transactions", "Health Score"],
                ...dailyData.map(d => [d.date, d.revenue, d.transaksi, d.health_score])
            ];
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "Business_Weekly_Report.csv");
        }

        function exportToExcel() {
            const data = [
                ["Date", "Revenue", "Transactions", "Health Score"],
                ...dailyData.map(d => [d.date, d.revenue, d.transaksi, d.health_score])
            ];
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "Business_Weekly_Report.xlsx");
        }

        function exportToPDF() {
            alert("PDF export feature will be implemented soon.");
        }

        document.addEventListener("DOMContentLoaded", async function() {
            await updateDataAndUI(true);

            setInterval(async () => {
                await updateDataAndUI();
            }, FETCH_INTERVAL);

            document.getElementById("toggleAnomalyBtn").addEventListener("click", toggleAnomaly);
            document.getElementById("exportCSV").addEventListener("click", exportToCSV);
            document.getElementById("exportExcel").addEventListener("click", exportToExcel);
            document.getElementById("exportPDF").addEventListener("click", exportToPDF);
            document.getElementById("refreshBtn").addEventListener("click", async () => {
                await updateDataAndUI(true);
            });
        });
    </script>
</body>
</html>
